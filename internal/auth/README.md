# Сервис аутентификации и работы с пользователями

Подключен к базе данных PostgreSQL 

## Основные методы для аутентификации
Во всех методах при ошибке возвращается код и 
{
"error": "текст ошибки"
}

В случае создания токенов методы возвращают их в заголовках Set-Cookie. Также для удобства они возвращают их напрямую в ответе

### Внимание, временно ошибки отправляются в виде `Error Trace` то есть вместо `"email and login is empty"` отправляется `op: grpc.Auth Error: ... : email and login is empty` тем самым необходимо валидировать их через частичное совпадение в строке


### /api/auth [post]
Используется для аутентификации пользователя. В случае нахождения его в базе данных возвращает access refresh токены. Также возвращает Set-Cookie заголовки с этими токена с нужным временем действия

#### Статусы 
- 400 (bad request) возникает при неправильном вводе данных. 
  - Неправильный json в body который нельзя считать "bad JSON"
  - Пустой email и login "email and login is empty"
  - Пустой пароль "pw is empty"
  - Неправильный пароль "password incorrect"
- 404 (not found) при отсутствии пользователя в базе данных
- 502 (bad gateway) при ошибке внутри сервиса. В этом случае ошибка логируется на микросервисе
- 504 (gateway timeout) при превышении времени ожидания запроса.

### /api/auth/reg [post]
Используется для регистрации пользователя. В случае успеха возвращаются токены так же с Set-Cookie заголовками
#### Статусы
- 302 (found) пользователь уже существует 
- 400 (bad request) возникает при неправильном вводе данных.
  - Неправильный json в body который нельзя считать "bad JSON"
  - Не совпадении паролей  "password not same"
  - Пустой email и login "email and login is empty"
  - Пустой пароль "pw is empty"
  - При несоответсвии пароля политике (более 5, менее 20 символов, минимум одна заглавная, один символ, одна цифра) "pw not in policy"
  - неправильный пароль "password incorrect"
- 502 (bad gateway) при ошибке внутри сервиса. В этом случае ошибка логируется на микросервисе
- 504 (gateway timeout) при превышении времени ожидания запроса.

### /api/auth/token [get]
Валидация токенов. Проверяет токены из cookie. В случае ошибки в access токене на основании refresh создает новый. Предпологается вызов при каждом действии при проверки сеанса авторизации

#### Статусы
- 201 при создании нового токена. Возвращает заголовок Set-Cookie
- 302 (found) пользователь уже существует
- 400 (bad request) возникает при неправильном вводе данных.
  - Пустой access и refresh (невозможен при текущей функциональности) "one of tokens is empty"
- 401 (unauthorized) при истечении сессии авторизации
  - При отсутсвии куки с рефреш токеном "refresh_token cookie missing"
  - Неправильный токен (refresh)
  - Refresh токен истек
- 502 (bad gateway) при ошибке внутри сервиса. В этом случае ошибка логируется на микросервисе
- 504 (gateway timeout) при превышении времени ожидания запроса.